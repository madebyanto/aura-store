<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Login Aura</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<style>
* { margin:0; padding:0; box-sizing:border-box; }
body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #E30AF5, #F174FF);
    color: #fff;
    display:flex; justify-content:center; align-items:center;
    height:100vh; text-align:center;
}
.container {
    background-color: rgba(255,255,255,0.1);
    padding: 30px; border-radius: 15px;
    box-shadow: 0px 10px 30px rgba(0,0,0,0.15);
    width:100%; max-width:400px;
}
.logo { width:150px; margin-bottom:20px; }
h1 { font-size:1.8em; margin-bottom:15px; font-weight:600; }
form { display:flex; flex-direction:column; }
input {
    padding:12px; margin:10px 0; border:1px solid #ddd;
    border-radius:8px; font-size:14px;
    background-color: rgba(255,255,255,0.3); color:#fff;
}
input:focus { outline:none; border-color:#F174FF; }
button {
    background-color:#F174FF; color:white;
    padding:12px; border:none; border-radius:8px;
    font-size:14px; cursor:pointer; transition:0.3s;
    margin-top:5px;
}
button:hover { background-color:#e008f6; }
#message-login { margin:15px 0; color:#ffb3d9; font-weight:600; }
#popup-dev {
    position:fixed; top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.5);
    display:none; justify-content:center; align-items:center;
    z-index:9999;
}
#popup-dev .popup-content {
    background:#fff; color:#000; padding:20px; border-radius:15px;
    text-align:center; max-width:300px;
}
#popup-dev img { width:80px; border-radius:50%; margin-bottom:10px; }
#popup-dev button {
    margin:5px; background:#F174FF; color:white; padding:10px 15px; border:none; border-radius:8px; cursor:pointer;
}
</style>
</head>
<body>

<div class="container">
    <img src="auraaccount.png" alt="Aura Account" class="logo">
    <h1>Accedi al tuo profilo Aura</h1>
    <div id="message-login"></div>
    <form id="login-form">
        <input type="email" id="login-email" placeholder="Email" required>
        <input type="password" id="login-password" placeholder="Password" required>
        <button type="submit">Accedi</button>
    </form>
    <p style="margin-top:10px; font-size:14px;">
        <a href="#" id="forgot-password" style="color:#ffffff;">Ho dimenticato la password</a>
    </p>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDsrHAtIh5bsYDHa1wz0LMcmciChAoRikU",
    authDomain: "myauraid-f03c6.firebaseapp.com",
    projectId: "myauraid-f03c6",
    storageBucket: "myauraid-f03c6.appspot.com",
    messagingSenderId: "190478237725",
    appId: "1:190478237725:web:0d39907473f511b85a06f4"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// LOGIN
const messageLogin = document.getElementById('message-login');
const loginForm = document.getElementById('login-form');
const popupDev = document.getElementById('popup-dev');
const devAvatar = document.getElementById('dev-avatar');
const btnYes = document.getElementById('btn-yes');
const btnNo = document.getElementById('btn-no');

loginForm.addEventListener('submit', function(e){
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;

    auth.signInWithEmailAndPassword(email,password)
    .then(async (userCredential)=>{
        const user = userCredential.user;
        if(!user.emailVerified){
            messageLogin.textContent="Conferma l'email prima di accedere.";
            return;
        }

        try{
            const doc = await db.collection("users").doc(user.uid).get();
            if(doc.exists){
                const userData = doc.data();
                if(userData.developer){
                    window.location.href = "index-beta.html";
                } else {
                    devAvatar.src = user.photoURL || "auraaccount.png";
                    popupDev.style.display="flex";
                    btnYes.onclick = ()=> { window.location.href="set_developer_profile.html"; }
                    btnNo.onclick = ()=> { popupDev.style.display="none"; }
                }
            } else {
                messageLogin.textContent="Errore: utente non trovato.";
            }
        } catch(err){
            messageLogin.textContent="Errore lettura dati: "+err.message;
        }
    })
    .catch((error)=>{
        if(error.code==='auth/user-disabled'){
            messageLogin.textContent="Account disabilitato.";
        } else {
            messageLogin.textContent="Errore: "+error.message;
        }
    });
});

// RECUPERO PASSWORD
document.getElementById('forgot-password').addEventListener('click', function(e){
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    if(!email){ messageLogin.textContent="Inserisci l'email sopra per recuperare la password."; return; }
    auth.sendPasswordResetEmail(email)
    .then(()=> messageLogin.textContent="Email di recupero inviata.")
    .catch((error)=> messageLogin.textContent="Errore: "+error.message);
});

// Mantieni login utente dopo refresh
auth.onAuthStateChanged(async (user)=>{
    if(user && user.emailVerified){
        try{
            const doc = await db.collection("users").doc(user.uid).get();
if(doc.exists){
    const userData = doc.data();
    if(userData.developer){
        window.location.href = "dashboard.html";
    } else {
        // Usa l'URL di profileImage dal documento Firestore
        devAvatar.src = userData.profileImage || "auraaccount.png";
        popupDev.style.display = "flex";
        btnYes.onclick = () => { window.location.href = "set_developer_profile.html"; }
        btnNo.onclick = () => { popupDev.style.display = "none"; }
    }
}
        } catch(err){ console.error(err); }
    }
});
</script>

</body>
</html>